{#
Página HTML para Crear Productos (templates/productos/crear.html)
HTML#}

{% extends 'base.html' %}

{% block title %}Crear Producto{% endblock %}

{% block content %}
    <h2 class="mb-4">Registrar Nuevo Producto</h2>

    <form method="POST" action="{{ url_for('crear_producto') }}" id="form-crear-producto">
        {{ form.hidden_tag() }}
        <div class="card p-4">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="categoria_id" class="form-label">Categoría de la Pieza:</label>
                    {{ form.categoria_id(class="form-select") }}
                    {% if form.categoria_id.errors %}<div class="invalid-feedback d-block">{% for error in form.categoria_id.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="pieza_id" class="form-label">Producto General (Tipo de Pieza):</label>
                    {{ form.pieza_id(class="form-select", disabled=True) }} 
                    {% if form.pieza_id.errors %}<div class="invalid-feedback d-block">{% for error in form.pieza_id.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>

                <div class="col-md-6 mb-3">
                    <label for="id_marca_vehiculo" class="form-label">Marca del Vehículo:</label>
                    {{ form.id_marca_vehiculo(class="form-select") }}
                    {% if form.id_marca_vehiculo.errors %}<div class="invalid-feedback d-block">{% for error in form.id_marca_vehiculo.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="id_modelo_vehiculo" class="form-label">Modelo del Vehículo:</label>
                    {{ form.id_modelo_vehiculo(class="form-select", disabled=True) }} 
                    {% if form.id_modelo_vehiculo.errors %}<div class="invalid-feedback d-block">{% for error in form.id_modelo_vehiculo.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    {{ form.descripcion.label(class="form-label") }}
                    {{ form.descripcion(class="form-control") }}
                    {% if form.descripcion.errors %}<div class="invalid-feedback d-block">{% for error in form.descripcion.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
                <div class="col-md-3 mb-3">
                    {{ form.marca_repuesto.label(class="form-label") }}
                    {{ form.marca_repuesto(class="form-control") }}
                    {% if form.marca_repuesto.errors %}<div class="invalid-feedback d-block">{% for error in form.marca_repuesto.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
                <div class="col-md-3 mb-3">
                    {{ form.generacion.label(class="form-label") }}
                    {{ form.generacion(class="form-control", placeholder="Ej: 2000-2005") }}
                    {% if form.generacion.errors %}<div class="invalid-feedback d-block">{% for error in form.generacion.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
                <div class="col-md-3 mb-3">
                    {{ form.precio_compra.label(class="form-label") }}
                    {{ form.precio_compra(class="form-control", placeholder="Ej: $ 50") }}
                    {% if form.precio_compra.errors %}<div class="invalid-feedback d-block">{% for error in form.precio_compra.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
                <div class="col-md-3 mb-3">
                    {{ form.precio_venta.label(class="form-label") }}
                    {{ form.precio_venta(class="form-control", placeholder="$") }}
                    {% if form.precio_venta.errors %}<div class="invalid-feedback d-block">{% for error in form.precio_venta.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
                <div class="col-md-2 mb-3">
                    {{ form.stock.label(class="form-label") }}
                    {{ form.stock(class="form-control") }}
                    {% if form.stock.errors %}<div class="invalid-feedback d-block">{% for error in form.stock.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
                <div class="col-md-3 mb-3">
                    {{ form.ubicacion.label(class="form-label") }}
                    {{ form.ubicacion(class="form-control", placeholder="Ej Pasillo C Estante 2") }}
                    {% if form.ubicacion.errors %}<div class="invalid-feedback d-block">{% for error in form.ubicacion.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
                </div>
            
            <div class="text-center mt-4">
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </div>
    </form>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Referencias a los elementos del formulario
            const categoriaSelect = $('#categoria_id');
            const piezasSelect = $('#pieza_id');
            const marcaVehiculoSelect = $('#id_marca_vehiculo');
            const modeloVehiculoSelect = $('#id_modelo_vehiculo');
            
        
            // Función para resetear y deshabilitar selectores
            function resetAndDisableSelect(selectElement, defaultText) {
                selectElement.html(`<option value="0">${defaultText}</option>`).prop('disabled', true);
            }

            // --- Lógica para Categoría de Pieza -> Pieza General ---
            async function fetchPiezas(categoria_id) {
                try {
                    const response = await fetch(`/api/piezas_por_categoria/${categoria_id}`);
                    const piezas = await response.json();
                    piezasSelect.empty().append('<option value="0">Selecciona una pieza</option>');
                    piezas.forEach(pieza => {
                        piezasSelect.append(`<option value="${pieza.id}">${pieza.nombre}</option>`);
                    });
                    piezasSelect.prop('disabled', false);
                } catch (error) {
                    console.error('Error al cargar piezas:', error);
                    resetAndDisableSelect(piezasSelect, 'Error al cargar');
                }
            }

            categoriaSelect.on('change', function() {
                const selectedCategoriaId = $(this).val();
                resetAndDisableSelect(piezasSelect, 'Selecciona una pieza');
                if (selectedCategoriaId != "0") {
                    fetchPiezas(selectedCategoriaId);
                }
            });

            // --- Lógica para Marca de Vehículo -> Modelo de Vehículo ---
            async function fetchModelos(marca_id) {
                try {
                    const response = await fetch(`/api/modelos_por_marca/${marca_id}`);
                    const modelos = await response.json();
                    modeloVehiculoSelect.empty().append('<option value="0">Selecciona un modelo</option>');
                    modelos.forEach(modelo => {
                        modeloVehiculoSelect.append(`<option value="${modelo.id}">${modelo.nombre}</option>`);
                        console.log(`tipos de modelo: ${modelo.nombre}`)
                    });
                    modeloVehiculoSelect.prop('disabled', false);
                } catch (error) {
                    console.error('Error al cargar modelos:', error);
                    resetAndDisableSelect(modeloVehiculoSelect, 'Error al cargar');
                }
            }

            marcaVehiculoSelect.on('change', function() {
                const selectedMarcaId = $(this).val();
                resetAndDisableSelect(modeloVehiculoSelect, 'Selecciona un modelo');
                if (selectedMarcaId != "0") {
                    fetchModelos(selectedMarcaId);
                }
            });

            // --- Inicialización al cargar la página ---
            // Si el formulario se renderiza con valores previos (ej. por un error de validación),
            // queremos que los selectores dependientes se carguen correctamente.
            if (categoriaSelect.val() != "0") {
                fetchPiezas(categoriaSelect.val());
            }
            if (marcaVehiculoSelect.val() != "0") {
                fetchModelos(marcaVehiculoSelect.val());
            }
        });
    </script>
{% endblock %}
    