{% extends 'base.html' %}

{% block title %}Registrar Nueva Venta{% endblock %}

{% block body_attributes %}
    {% if usd_rate %}data-usd-rate="{{ usd_rate }}"{% endif %}
    {% if eur_rate %}data-eur-rate="{{ eur_rate }}"{% endif %}
{% endblock %}

{% block content %}
    <style>
        .form-label{
            color:#fff2d1;
            font-family:'Google Sans';
            font-size:large;
        }
    </style>
    <h2 class="mb-4 display-5">Registrar Nueva Venta</h2>
    <form method="POST" action="{{ url_for('crear_venta') }}" id="form-venta-principal">
        {{ form.hidden_tag() }}

        <div class="mb-3">
            {{ form.cliente_id.label(class="form-label") }}
            {{ form.cliente_id(class="form-select") }}
        </div>

        <div class="mb-3">
            {{ form.moneda_venta.label(class="form-label") }}
            {{ form.moneda_venta(class="form-select") }}
        </div>

        <div class="mb-3">
            {{ form.tasa_cambio_actual.label(class="form-label") }}
            {{ form.tasa_cambio_actual(class="form-control") }}
        </div>
        
        <div class="card p-4 mb-4">
            <h3 class="card-title mb-4 text-center">Buscar y Seleccionar Productos</h3>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="marca_vehiculo_venta" class="form-label " style="color:#333028">Marca del Vehículo:</label>
                    <select class="form-select" id="marca_vehiculo_venta" name="marca_vehiculo_venta">
                        <option value="">Selecciona una marca</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="modelo_vehiculo_venta" class="form-label" style="color:#333028">Modelo del Vehículo:</label>
                    <select class="form-select" id="modelo_vehiculo_venta" name="modelo_vehiculo_venta" disabled>
                        <option value="">Selecciona un modelo</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="categoria_producto_venta" class="form-label" style="color:#333028">Categoría de la Pieza:</label>
                    <select class="form-select" id="categoria_producto_venta" name="categoria_producto_venta">
                        <option value="">Selecciona una categoría</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="categoria_pieza_venta" class="form-label" style="color:#333028">Tipo de Pieza:</label>
                    <select class="form-select" id="categoria_pieza_venta" name="categoria_pieza_venta" disabled>
                        <option value="">Selecciona el tipo de pieza</option>
                    </select>
                </div>
            </div>
            <hr class="mt-4">
            <div id="productos-filtrados-venta" class="mt-3">
                <div class="alert alert-info">Usa los filtros de arriba para buscar productos existentes.</div>
            </div>
        </div>

        <div id="productos-venta-list" class="mt-4">
            <h4>Productos de esta Venta</h4>
            <div class="alert alert-info" id="no-productos-msg-venta">Aún no has añadido productos a esta venta.</div>
        </div>

        <button type="submit" class="btn btn-primary mt-4">Registrar Venta</button>
    </form>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            const marcaSelectVenta = $('#marca_vehiculo_venta');
            const modeloSelectVenta = $('#modelo_vehiculo_venta');
            const categoriaSelectVenta = $('#categoria_producto_venta');
            const piezaSelectVenta = $('#categoria_pieza_venta');
            const productosContainerVenta = $('#productos-filtrados-venta');
            const productosVentaList = $('#productos-venta-list');
            let formIndexVenta = 0; // Contador para los productos de la venta
            const formPrincipal = $('#form-venta-principal');
            
            function showCustomFlash(message, category) {
                
            }

            // Funciones para cargar selects (marcas, modelos, etc.)
            async function fetchMarcas(targetSelect) {
                try {
                    const response = await fetch(`/api/marcas_vehiculo/`);
                    const marcas = await response.json();
                    targetSelect.empty().append('<option value="">Selecciona una marca</option>');
                    marcas.forEach(marca => {
                        targetSelect.append(`<option value="${marca.id}">${marca.nombre}</option>`);
                    });
                    targetSelect.prop('disabled', false);
                } catch (error) {
                    console.error('Error al cargar las marcas:', error);
                    showCustomFlash('Error al cargar las marcas de vehículos.', 'danger');
                }
            }
            async function fetchModelos(marca_id, targetSelect) {
                try {
                    const response = await fetch(`/api/modelos_por_marca/${marca_id}`);
                    const modelos = await response.json();
                    targetSelect.empty().append('<option value="">Selecciona un modelo</option>');
                    modelos.forEach(modelo => {
                        targetSelect.append(`<option value="${modelo.id}">${modelo.nombre}</option>`);
                    });
                    targetSelect.prop('disabled', false);
                } catch (error) {
                    console.error('Error al cargar modelos:', error);
                    showCustomFlash('Error al cargar los modelos de vehículos.', 'danger');
                }
            }
            async function fetchCategorias(targetSelect) {
                try {
                    const response = await fetch(`/api/categoria_de_pieza`);
                    const categorias = await response.json();
                    targetSelect.empty().append('<option value="">Selecciona una categoría</option>');
                    categorias.forEach(categoria => {
                        targetSelect.append(`<option value="${categoria.id}">${categoria.nombre}</option>`);
                    });
                    targetSelect.prop('disabled', false);
                } catch (error) {
                    console.error('Error al cargar categorías:', error);
                    showCustomFlash('Error al cargar las categorías de piezas.', 'danger');
                }
            }
            async function fetchPiezas(categoria_id, targetSelect) {
                try {
                    const response = await fetch(`/api/piezas_por_categoria/${categoria_id}`);
                    const piezas = await response.json();
                    targetSelect.empty().append('<option value="">Selecciona un tipo de pieza</option>');
                    piezas.forEach(pieza => {
                        targetSelect.append(`<option value="${pieza.id}">${pieza.nombre}</option>`);
                    });
                    targetSelect.prop('disabled', false);
                } catch (error) {
                    console.error('Error al cargar piezas:', error);
                    showCustomFlash('Error al cargar los tipos de piezas.', 'danger');
                }
            }
            
            // Función de búsqueda principal
            async function fetchProductosFiltradosVenta(marca, modelo, categoria, pieza) { 
                try {
                    const params = new URLSearchParams();
                    if (marca) params.append('marca_id', marca);
                    if (modelo) params.append('modelo_id', modelo);
                    if (categoria) params.append('categoria_id', categoria);
                    if (pieza) params.append('pieza_id', pieza); 
                    
                    const response = await fetch(`/api/productos_filtrados?${params.toString()}`);
                    const productos = await response.json();
                    
                    let html = '';
                    if (productos.length > 0) {
                        html = `<h4 style="color:#333028">Productos encontrados</h4>
                                <table class="table table-striped table-bordered table-hover">
                                <thead><tr><th>Descripción</th><th>Stock</th><th>Precio Venta</th><th>Acción</th></tr></thead>
                                <tbody>`;
                        productos.forEach(p => {
                            html += `<tr data-producto='${JSON.stringify(p)}'>
                                        <td>${p.descripcion}</td>
                                        <td><span class="badge bg-secondary">${p.stock}</span></td>
                                        <td>$. ${p.precio_venta}</td>
                                        <td><button type="button" class="btn btn-sm btn-primary btn-add-producto-venta">Añadir a Venta</button></td>
                                    </tr>`;
                        });
                        html += `</tbody></table>`;
                    } else {
                        html = `<div class="alert alert-warning">No se encontraron productos con estos criterios.</div>`;
                    }
                    productosContainerVenta.html(html);

                    $('.btn-add-producto-venta').on('click', function() {
                        const productoData = $(this).closest('tr').data('producto');
                        addProductoToVenta(productoData);
                    });
                } catch (error) {
                    console.error('Error al cargar productos filtrados:', error);
                    productosContainerVenta.html(`<div class="alert alert-danger">Hubo un error al buscar productos.</div>`);
                }
            }
            
            // Función para añadir productos a la venta (similar a la de compra, pero con validación de stock)
            function addProductoToVenta(producto) {
                if (producto.stock <= 0) {
                    showCustomFlash(`No hay stock disponible para "${producto.descripcion}".`, 'danger');
                    return;
                }

                // Validación para evitar duplicados
                let isDuplicate = false;
                productosVentaList.find('.detalle-venta-form input[name$="-producto_id"]').each(function() {
                    if (parseInt($(this).val()) === producto.id) {
                        isDuplicate = true;
                        return false;
                    }
                });

                if (isDuplicate) {
                    showCustomFlash(`El producto "${producto.descripcion}" ya ha sido añadido a esta venta.`, 'warning');
                    return;
                }

                $('#no-productos-msg-venta').hide();
                const csrfToken = $('input[name="csrf_token"]').val();
                
                const newFormHtml = `
                    <div class="detalle-venta-form card p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>${producto.descripcion} (${producto.marca_repuesto})</h5>
                            <button type="button" class="btn btn-danger btn-sm btn-remove-item-venta">&times;</button>
                        </div>
                        <input type="hidden" name="productos_vendidos-${formIndexVenta}-producto_id" value="${producto.id}">
                        <input type="hidden" name="productos_vendidos-${formIndexVenta}-precio_venta" value="${producto.precio_venta}">
                        <input type="hidden" name="productos_vendidos-${formIndexVenta}-csrf_token" value="${csrfToken}">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="color:#333028">Cantidad:</label>
                                <input type="number" name="productos_vendidos-${formIndexVenta}-cantidad" class="form-control" value="1" min="1" max="${producto.stock}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="color:#333028">Precio de Venta:</label>
                                <input type="number" step="0.01" name="productos_vendidos-${formIndexVenta}-precio_venta" class="form-control" min="0.01" value="${producto.precio_venta}" required>
                            </div>
                        </div>
                    </div>`;
                
                productosVentaList.append(newFormHtml);
                formIndexVenta++;

                $('.btn-remove-item-venta').on('click', function() {
                    $(this).closest('.detalle-venta-form').remove();
                    if ($('.detalle-venta-form').length === 0) {
                        $('#no-productos-msg-venta').show();
                    }
                });
            }

            // Event listeners para los filtros
            marcaSelectVenta.on('change', () => {
                fetchModelos(marcaSelectVenta.val(), modeloSelectVenta);
                fetchProductosFiltradosVenta(marcaSelectVenta.val(), null, categoriaSelectVenta.val(), piezaSelectVenta.val());
            });
            modeloSelectVenta.on('change', () => {
                fetchProductosFiltradosVenta(marcaSelectVenta.val(), modeloSelectVenta.val(), categoriaSelectVenta.val(), piezaSelectVenta.val());
            });
            categoriaSelectVenta.on('change', () => {
                fetchPiezas(categoriaSelectVenta.val(), piezaSelectVenta);
                fetchProductosFiltradosVenta(marcaSelectVenta.val(), modeloSelectVenta.val(), categoriaSelectVenta.val(), piezaSelectVenta.val());
            });
            piezaSelectVenta.on('change', () => {
                fetchProductosFiltradosVenta(marcaSelectVenta.val(), modeloSelectVenta.val(), categoriaSelectVenta.val(), piezaSelectVenta.val());
            });

            // Lógica para la tasa de cambio
            const monedaVentaSelect = document.getElementById('moneda_venta');
            const tasaCambioInput = document.getElementById('tasa_cambio_actual');
            
            if (monedaVentaSelect && tasaCambioInput) {
                const usdRate = parseFloat(document.body.dataset.usdRate || '0');
                const eurRate = parseFloat(document.body.dataset.eurRate || '0');
                
                monedaVentaSelect.addEventListener('change', function() {
                    const selectedCurrency = this.value;
                    if (selectedCurrency === 'USD') {
                        tasaCambioInput.value = usdRate.toFixed(4);
                    } else if (selectedCurrency === 'EUR') {
                        tasaCambioInput.value = eurRate.toFixed(4);
                    } else {
                        tasaCambioInput.value = '0.0000';
                    }
                });
            }
            
            // Cargar los selects iniciales
            fetchMarcas(marcaSelectVenta);
            fetchCategorias(categoriaSelectVenta);
        });
    </script>
    
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            var productsContainerVenta = document.getElementById('productos-container-venta');
            var addProductBtnVenta = document.getElementById('add-product-btn-venta');
            
            var prototypeVenta = productsContainerVenta.children.length > 0 ? productsContainerVenta.children[0].outerHTML : null;

            if (!prototypeVenta) {
                console.warn('No initial product item found for prototype. Dynamic add might not work as expected.');
                return;
            }

            function addProductItemVenta() {
                var newIndex = productsContainerVenta.children.length;
                var newItem = document.createElement('div');
                newItem.innerHTML = prototypeVenta;
                newItem.classList.add('card', 'mb-3', 'p-3', 'product-item-venta');

                newItem.querySelectorAll('[name]').forEach(function(input) {
                    var oldName = input.name;
                    var oldId = input.id;
                    if (oldName && oldName.includes('productos_vendidos-0-')) {
                        input.name = oldName.replace('productos_vendidos-0-', 'productos_vendidos-' + newIndex + '-');
                        input.id = oldId.replace('productos_vendidos-0-', 'productos_vendidos-' + newIndex + '-');
                        if (input.type !== 'hidden') {
                            input.value = '';
                        }
                    }
                    if (input.labels && input.labels[0]) {
                        input.labels[0].setAttribute('for', input.id);
                    }
                });

                newItem.querySelector('h5').innerText = 'Producto #' + (newIndex + 1);
                productsContainerVenta.appendChild(newItem);
            }

            addProductBtnVenta.addEventListener('click', addProductItemVenta);
            
            // Lógica JS para cambiar la tasa_cambio_actual mostrada
            var monedaVentaSelect = document.getElementById('moneda_venta');
            var tasaCambioInput = document.getElementById('tasa_cambio_actual');

            if (monedaVentaSelect && tasaCambioInput) {
                var usdRate = parseFloat(document.body.dataset.usdRate || '0');
                var eurRate = parseFloat(document.body.dataset.eurRate || '0');
                
                var initialSelectedCurrency = monedaVentaSelect.value;
                
                if (initialSelectedCurrency === 'USD') {
                    tasaCambioInput.value = usdRate.toFixed(4);
                } else if (initialSelectedCurrency === 'EUR') {
                    tasaCambioInput.value = eurRate.toFixed(4);
                } else {
                    tasaCambioInput.value = '0.0000';
                }

                monedaVentaSelect.addEventListener('change', function() {
                    var selectedCurrency = this.value;
                    if (selectedCurrency === 'USD') {
                        tasaCambioInput.value = usdRate.toFixed(4);
                    } else if (selectedCurrency === 'EUR') {
                        tasaCambioInput.value = eurRate.toFixed(4);
                    } else {
                        tasaCambioInput.value = '0.0000';
                    }
                });
            }
        });
    </script>




{% endblock %}
</body>
